<core:FragmentDefinition
    xmlns="sap.m"
    xmlns:core="sap.ui.core"
    xmlns:l="sap.ui.layout"
    xmlns:f="sap.ui.layout.form"
    xmlns:grid="sap.ui.layout.cssgrid">

    <Dialog
        title="Transaction Details: {transaction>id}"
        contentWidth="900px"
        contentHeight="600px"
        resizable="true"
        draggable="true">
        
        <customHeader>
            <Bar>
                <contentLeft>
                    <Title text="Transaction Details" level="H2"/>
                </contentLeft>
                <contentRight>
                    <Button icon="sap-icon://decline" press="onCloseDetailDialog" />
                </contentRight>
            </Bar>
        </customHeader>

        <content>
            <VBox class="sapUiSmallMargin">
                <MessageStrip
                    text="{= ${transaction>status} === 'QUALIFIED' ? 'Qualified Transaction' : 
                          ${transaction>status} === 'REJECTED' ? 'Transaction Rejected: ' + ${transaction>rejectionReason} : 
                          ${transaction>status} === 'DISPUTED' ? 'Under Dispute: ' + ${transaction>disputeReason} : ${transaction>status} }"
                    type="{= ${transaction>status} === 'QUALIFIED' ? 'Success' : 
                          ${transaction>status} === 'REJECTED' ? 'Error' : 
                          ${transaction>status} === 'DISPUTED' ? 'Warning' : 'Information' }"
                    showIcon="true"
                    class="sapUiTinyMarginBottom" />
                
                <HBox alignItems="Center">
                    <ObjectStatus 
                        text="{= ${transaction>periodStatus} === 'HARD_CLOSE' ? 'Period Hard Closed' : 'Period Open' }"
                        icon="{= ${transaction>periodStatus} === 'HARD_CLOSE' ? 'sap-icon://locked' : 'sap-icon://unlocked' }"
                        state="{= ${transaction>periodStatus} === 'HARD_CLOSE' ? 'Error' : 'Success' }"
                        inverted="true" />
                </HBox>
            </VBox>

            <IconTabBar id="idIconTabBar" expanded="true" class="sapUiResponsiveContentPadding">
                <items>
                    <IconTabFilter icon="sap-icon://sales-order" text="Transaction Details" key="details">
                        <grid:CSSGrid gridTemplateColumns="1fr 1fr" gridGap="1rem">
                            
                            <Panel headerText="Agreement Information" backgroundDesign="Transparent">
                                <f:SimpleForm layout="ResponsiveGridLayout" labelSpanXL="4" labelSpanL="4" labelSpanM="4" labelSpanS="12">
                                    <Label text="Agreement No" />
                                    <Link text="{transaction>agreement}" />
                                    <Label text="Name" />
                                    <Text text="{transaction>agreementName}" />
                                    <Label text="Fiscal Period" />
                                    <ObjectStatus text="{transaction>period}" state="Indication06" inverted="true" />
                                </f:SimpleForm>
                            </Panel>

                            <Panel headerText="Financial Details" backgroundDesign="Transparent">
                                <f:SimpleForm layout="ResponsiveGridLayout" labelSpanXL="4" labelSpanL="4" labelSpanM="4" labelSpanS="12">
                                    <Label text="Net Amount" />
                                    <Text text="{parts:[{path:'transaction>netAmount'},{path:'transaction>currency'}], type: 'sap.ui.model.type.Currency'}" />
                                    <Label text="Eligible Amount" />
                                    <Text text="{parts:[{path:'transaction>eligible'},{path:'transaction>currency'}], type: 'sap.ui.model.type.Currency'}" />
                                    <Label text="Rate Applied" />
                                    <Text text="{transaction>rate}%" />
                                    <Label text="Rebate Amount" design="Bold"/>
                                    <ObjectNumber 
                                        number="{parts:[{path:'transaction>rebate'},{path:'transaction>currency'}], type: 'sap.ui.model.type.Currency'}" 
                                        state="Success" />
                                </f:SimpleForm>
                            </Panel>

                            <Panel headerText="Accrual Information" visible="{= !!${transaction>accrualInfo} }" width="100%">
                                <layoutData><grid:GridItemLayoutData gridColumn="1 / span 2"/></layoutData>
                                <grid:CSSGrid gridTemplateColumns="repeat(4, 1fr)" gridGap="1rem">
                                    <VBox>
                                        <Label text="Run Number" design="Bold"/>
                                        <Link text="{transaction>accrualInfo/runNumber}"/>
                                    </VBox>
                                    <VBox>
                                        <Label text="Run Date" design="Bold"/>
                                        <Text text="{path: 'transaction>accrualInfo/runDate', type: 'sap.ui.model.type.Date'}"/>
                                    </VBox>
                                    <VBox>
                                        <Label text="FI Document" design="Bold"/>
                                        <Text text="{transaction>accrualInfo/fiDocument}"/>
                                    </VBox>
                                    <VBox>
                                        <Label text="Delta Amount" design="Bold"/>
                                        <Text text="{transaction>accrualInfo/deltaAmount}"/>
                                    </VBox>
                                </grid:CSSGrid>
                            </Panel>

                        </grid:CSSGrid>
                    </IconTabFilter>

                    <IconTabFilter icon="sap-icon://simulate" text="Calculation Trace" key="calc">
                        
                        <Panel class="sapUiSmallMarginBottom">
                            <headerToolbar>
                                <Toolbar>
                                    <Title text="Agreement Rule Applied" />
                                    <ToolbarSpacer />
                                    <ObjectStatus text="{transaction>calculationTrace/agreementRule}" state="Information" inverted="true" />
                                </Toolbar>
                            </headerToolbar>
                        </Panel>

                        <Panel headerText="Eligibility Validation" class="sapUiSmallMarginBottom">
                            <List items="{transaction>calculationTrace/eligibilityChecks}">
                                <CustomListItem>
                                    <HBox alignItems="Center" class="sapUiSmallMargin">
                                        <core:Icon 
                                            src="{= ${transaction>result} === 'PASS' ? 'sap-icon://accept' : 'sap-icon://decline' }" 
                                            color="{= ${transaction>result} === 'PASS' ? 'Positive' : 'Negative' }" 
                                            size="1.5rem" 
                                            class="sapUiSmallMarginEnd"/>
                                        <VBox>
                                            <Title text="{transaction>check}" level="H5"/>
                                            <Text text="{transaction>detail}" class="sapUiTinyMarginTop"/>
                                        </VBox>
                                        <ToolbarSpacer />
                                        <ObjectStatus text="{transaction>result}" state="{= ${transaction>result} === 'PASS' ? 'Success' : 'Error' }" />
                                    </HBox>
                                </CustomListItem>
                            </List>
                        </Panel>

                        <Panel headerText="Volume Accumulation &amp; Tiers" visible="{= !!${transaction>calculationTrace/volumeAccumulation} }">
                            <HBox justifyContent="SpaceAround" alignItems="Center" class="sapUiMediumMarginBottom sapUiMediumMarginTop">
                                <VBox alignItems="Center">
                                    <Label text="Previous Volume" />
                                    <Title text="{transaction>calculationTrace/volumeAccumulation/previousVolume} {transaction>calculationTrace/volumeAccumulation/unit}" />
                                </VBox>
                                <core:Icon src="sap-icon://add" size="1.5rem" color="#999"/>
                                <VBox alignItems="Center">
                                    <Label text="Current Invoice" />
                                    <Title text="{transaction>calculationTrace/volumeAccumulation/currentInvoice} {transaction>calculationTrace/volumeAccumulation/unit}"/>
                                </VBox>
                                <core:Icon src="sap-icon://initiative" size="1.5rem" color="#999"/>
                                <VBox alignItems="Center">
                                    <Label text="New Total" />
                                    <Title text="{transaction>calculationTrace/volumeAccumulation/newTotal} {transaction>calculationTrace/volumeAccumulation/unit}"/>
                                </VBox>
                            </HBox>
                            
                            <MessageStrip 
                                text="Tier Applied: {transaction>calculationTrace/tierApplied/range} @ {transaction>calculationTrace/tierApplied/rate}%" 
                                type="Information" 
                                showIcon="true" 
                                class="sapUiSmallMargin"/>
                        </Panel>

                        <Panel headerText="Final Calculation">
                            <VBox alignItems="Center" class="sapUiMediumMargin">
                                <Text text="{transaction>calculationTrace/calculation/formula}" class="sapUiSmallMarginBottom"/>
                                <Title level="H3" text="{parts:[{path:'transaction>eligible'},{path:'transaction>currency'}], type: 'sap.ui.model.type.Currency'} Ã— {transaction>rate}% = {parts:[{path:'transaction>rebate'},{path:'transaction>currency'}], type: 'sap.ui.model.type.Currency'}" />
                            </VBox>
                        </Panel>

                    </IconTabFilter>
                </items>
            </IconTabBar>
        </content>
        <buttons>
            <Button text="Close" press="onCloseDetailDialog" />
        </buttons>
    </Dialog>
</core:FragmentDefinition>